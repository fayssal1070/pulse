generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id                      String                   @id @default(cuid())
  email                   String                   @unique
  createdAt               DateTime                 @default(now())
  passwordHash            String
  memberships             Membership[]
  notificationPreferences NotificationPreference[]
}

model Organization {
  id                      String                   @id @default(cuid())
  name                    String
  createdAt               DateTime                 @default(now())
  budgetMonthlyEUR        Float?
  telegramBotToken        String?
  telegramChatId          String?
  demoDataLoadedAt        DateTime?
  onboardingCompletedAt   DateTime?
  plan                    String                   @default("FREE") // "FREE" | "PRO" | "BUSINESS"
  stripeCustomerId        String?
  stripeSubscriptionId    String?
  stripePriceId           String?
  subscriptionStatus      String? // "active", "trialing", "past_due", "canceled", etc.
  currentPeriodEnd        DateTime?
  cancelAtPeriodEnd       Boolean                  @default(false)
  // AWS CUR configuration
  awsCurEnabled           Boolean                  @default(false)
  awsCurBucket            String?
  awsCurPrefix            String?
  awsCurRegion            String?
  awsPayerAccountId       String?
  awsAssumeRoleArn        String? // Cross-account role ARN
  // AI Gateway configuration
  aiGatewayEnabled        Boolean                  @default(false)
  aiLogRetentionDays      Int                      @default(90) // Days to retain AI request logs
  alertRules              AlertRule[]
  cloudAccounts           CloudAccount[]
  costRecords             CostRecord[]
  costEvents              CostEvent[]
  budgets                 Budget[]
  aiGatewayKeys           AiGatewayKey[]
  aiPolicies              AiPolicy[]
  aiRequestLogs           AiRequestLog[]
  ingestionBatches        IngestionBatch[]
  invitations             Invitation[]
  memberships             Membership[]
  orgIntegrations         OrgIntegration[]
  notificationPreferences NotificationPreference[]
  teams                   Team[]
  projects                Project[]
  apps                    App[]
  clients                 Client[]
  cronRuns                CronRun[]
  aiProviderConnections   AiProviderConnection[]
  aiModelRoutes           AiModelRoute[]
  webhooks                OrgWebhook[]
  webhookDeliveries       OrgWebhookDelivery[]

  @@index([stripeCustomerId])
  @@index([stripeSubscriptionId])
  @@index([awsCurEnabled])
  @@index([aiGatewayEnabled])
}

model Membership {
  id           String       @id @default(cuid())
  userId       String
  orgId        String
  role         String       @default("member")
  teamId       String? // Team assignment
  createdAt    DateTime     @default(now())
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  team         Team?        @relation(fields: [teamId], references: [id], onDelete: SetNull)

  @@unique([userId, orgId])
  @@index([orgId])
  @@index([teamId])
}

model CostRecord {
  id           String       @id @default(cuid())
  orgId        String
  date         DateTime
  provider     String
  service      String
  amountEUR    Float
  currency     String
  createdAt    DateTime     @default(now())
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@index([orgId])
  @@index([orgId, date])
}

model AlertRule {
  id              String       @id @default(cuid())
  orgId           String
  name            String
  type            String // "DAILY_SPIKE" | "TOP_CONSUMER_SHARE" | "CUR_STALE" | "NO_BUDGETS" | "BUDGET_STATUS" | "MONTHLY_BUDGET" (legacy)
  enabled         Boolean      @default(true)
  thresholdEUR    Float? // Optional for some rule types
  spikePercent    Float? // For DAILY_SPIKE (e.g., 50 for 50%)
  topSharePercent Float? // For TOP_CONSUMER_SHARE (e.g., 30 for 30%)
  lookbackDays    Int          @default(7) // For DAILY_SPIKE baseline
  providerFilter  String? // "AWS" | "AI" | "TOTAL" | null (all)
  notifyEmail     Boolean      @default(false)
  cooldownHours   Int          @default(24)
  createdByUserId String?
  lastTriggeredAt DateTime?
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  organization    Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  alertEvents     AlertEvent[]

  @@index([orgId])
  @@index([orgId, enabled])
}

model AlertEvent {
  id          String    @id @default(cuid())
  orgId       String
  alertId     String
  triggeredAt DateTime  @default(now())
  periodStart DateTime
  periodEnd   DateTime
  severity    String    @default("INFO") // "INFO" | "WARN" | "CRITICAL"
  amountEUR   Float
  message     String
  metadata    String? // JSON string for additional data
  alertRule   AlertRule @relation(fields: [alertId], references: [id], onDelete: Cascade)

  @@index([orgId])
  @@index([alertId])
  @@index([orgId, triggeredAt])
  @@index([orgId, severity])
}

model InAppNotification {
  id        String    @id @default(cuid())
  orgId     String
  userId    String? // null for org-wide notifications
  title     String
  body      String
  readAt    DateTime?
  createdAt DateTime  @default(now())

  @@index([orgId])
  @@index([userId])
  @@index([orgId, readAt])
  @@index([orgId, createdAt])
}

model Invitation {
  id           String       @id @default(cuid())
  token        String       @unique
  email        String
  orgId        String
  expiresAt    DateTime
  acceptedAt   DateTime?
  createdAt    DateTime     @default(now())
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@index([orgId])
  @@index([token])
}

model Lead {
  id                     String   @id @default(cuid())
  email                  String
  company                String
  role                   String?
  cloudProvider          String?
  monthlyCloudSpendRange String?
  message                String?
  archived               Boolean  @default(false)
  createdAt              DateTime @default(now())

  @@index([email])
  @@index([createdAt])
  @@index([archived])
}

model CloudAccount {
  id                String       @id @default(cuid())
  orgId             String
  provider          String
  accountName       String
  accountIdentifier String?
  connectionType    String? // e.g., "COST_EXPLORER", "CSV", "MANUAL", "CUR"
  roleArn           String? // AWS Role ARN for AssumeRole
  externalId        String? // AWS External ID for AssumeRole
  status            String       @default("pending") // "pending", "active", "error", "disabled"
  lastSyncedAt      DateTime?
  lastSyncError     String?
  notes             String?
  // CUR-specific fields
  curBucket         String? // Override org-level CUR bucket
  curPrefix         String? // Override org-level CUR prefix
  curRegion         String? // Override org-level CUR region
  lastCurSyncAt     DateTime?
  lastCurSyncError  String?
  createdAt         DateTime     @default(now())
  organization      Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@index([orgId])
  @@index([status])
  @@index([provider, connectionType])
}

model JobLock {
  id          String   @id @default("aws-cost-sync")
  lockedUntil DateTime
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// Unified CostEvent model - source of truth for all costs (AWS + AI)
model CostEvent {
  id               String       @id @default(cuid())
  orgId            String
  source           String // "AWS" | "AI"
  occurredAt       DateTime // Timestamp of the cost event
  amountEur        Decimal      @db.Decimal(12, 4)
  amountUsd        Decimal?     @db.Decimal(12, 4)
  currency         String       @default("EUR")
  provider         String // "aws" | "openai" | "anthropic" | "google" | etc.
  resourceType     String // AWS service name or "LLM_CALL"
  service          String // e.g., "EC2", "S3", "RDS" or "OpenAI", "Anthropic"
  usageType        String? // CUR usage type or "tokens"
  quantity         Decimal?     @db.Decimal(15, 6) // tokens or usage quantity
  unit             String? // "Hrs", "GB-Mo", "TOKENS", etc.
  costCategory     String? // "Compute", "Storage", "AI", "Network", etc.
  dimensions       Json? // { userId, teamId, projectId, appId, clientId, model, taskType }
  // Direct dimension references for efficient querying
  teamId           String?
  projectId        String?
  appId            String?
  clientId         String?
  tags             Json? // AWS tags or custom tags
  rawRef           Json? // CUR line identifiers or AI requestId
  uniqueHash       String       @unique // SHA-256 hash for deduplication
  ingestionBatchId String? // For batch tracking
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt
  organization     Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  team             Team?        @relation(fields: [teamId], references: [id], onDelete: SetNull)
  project          Project?     @relation(fields: [projectId], references: [id], onDelete: SetNull)
  app              App?         @relation(fields: [appId], references: [id], onDelete: SetNull)
  client           Client?      @relation(fields: [clientId], references: [id], onDelete: SetNull)

  @@unique([orgId, uniqueHash], map: "CostEvent_orgId_uniqueHash_key")
  @@index([orgId])
  @@index([orgId, occurredAt])
  @@index([orgId, source])
  @@index([orgId, source, occurredAt])
  @@index([orgId, provider])
  @@index([orgId, teamId])
  @@index([orgId, projectId])
  @@index([orgId, appId])
  @@index([orgId, clientId])
  @@index([ingestionBatchId])
}

// Ingestion batch tracking for CUR syncs
model IngestionBatch {
  id               String       @id @default(cuid())
  orgId            String
  batchId          String       @unique // Human-readable batch ID (e.g., "cur-2025-01-25-abc123")
  source           String       @default("AWS_CUR") // "AWS_CUR" | "AI_GATEWAY" | etc.
  status           String       @default("running") // "running" | "completed" | "failed" | "partial"
  startedAt        DateTime     @default(now())
  finishedAt       DateTime?
  objectsProcessed Int          @default(0)
  rowsParsed       Int          @default(0)
  eventsUpserted   Int          @default(0)
  errorsCount      Int          @default(0)
  sampleError      String? // First error message (truncated)
  metadata         Json? // Additional batch metadata
  organization     Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@index([orgId])
  @@index([orgId, startedAt])
  @@index([orgId, status])
  @@index([batchId])
}

// Budget model - supports org/team/project/app/client scopes
model Budget {
  id                String       @id @default(cuid())
  orgId             String
  name              String
  scopeType         String // "ORG" | "TEAM" | "PROJECT" | "APP" | "CLIENT"
  scopeId           String? // ID of team/project/app/client (null for ORG)
  period            String       @default("MONTHLY") // "MONTHLY" | "DAILY"
  amountEur         Decimal      @db.Decimal(12, 4)
  alertThresholdPct Int          @default(80) // Alert at X% of budget
  hardLimit         Boolean      @default(false) // If true, block/restrict when exceeded
  actions           Json? // { recommend: boolean, block: boolean, downgradeModel: string }
  enabled           Boolean      @default(true)
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt
  organization      Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@index([orgId])
  @@index([orgId, scopeType, scopeId])
  @@index([orgId, enabled])
}

// AI Gateway API Keys
model AiGatewayKey {
  id               String              @id @default(cuid())
  orgId            String
  keyHash          String              @unique // SHA-256 hash of the API key
  keyPrefix        String // First 8 chars for display
  status           String              @default("active") // "active" | "revoked"
  createdByUserId  String
  enabled          Boolean             @default(true)
  defaultAppId     String? // Optional default app for attribution
  defaultProjectId String? // Optional default project for attribution
  defaultClientId  String? // Optional default client for attribution
  rateLimitRpm     Int? // Rate limit per minute (null = unlimited)
  createdAt        DateTime            @default(now())
  revokedAt        DateTime?
  organization     Organization        @relation(fields: [orgId], references: [id], onDelete: Cascade)
  defaultApp       App?                @relation(fields: [defaultAppId], references: [id], onDelete: SetNull)
  defaultProject   Project?            @relation(fields: [defaultProjectId], references: [id], onDelete: SetNull)
  defaultClient    Client?             @relation(fields: [defaultClientId], references: [id], onDelete: SetNull)
  usageWindows     ApiKeyUsageWindow[]

  @@index([orgId])
  @@index([keyHash])
  @@index([orgId, status])
  @@index([enabled])
}

// AI Gateway Policies
model AiPolicy {
  id                 String       @id @default(cuid())
  orgId              String
  name               String
  allowedModels      Json? // Array of allowed model identifiers
  blockedModels      Json? // Array of blocked model identifiers
  maxCostPerDayEur   Decimal?     @db.Decimal(12, 4)
  maxTokensPerReq    Int?
  requireAttribution Boolean      @default(false) // If true, appId required
  enabled            Boolean      @default(true)
  createdAt          DateTime     @default(now())
  updatedAt          DateTime     @updatedAt
  organization       Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@index([orgId])
  @@index([orgId, enabled])
}

// AI Request Logs (audit trail)
model AiRequestLog {
  id               String       @id @default(cuid())
  orgId            String
  occurredAt       DateTime     @default(now())
  userId           String?
  teamId           String?
  projectId        String?
  appId            String?
  clientId         String?
  provider         String // "openai", "anthropic", "google", etc.
  model            String // Model identifier
  promptHash       String? // SHA-256 hash of prompt (not raw prompt)
  inputTokens      Int?
  outputTokens     Int?
  totalTokens      Int?
  estimatedCostEur Decimal?     @db.Decimal(12, 4)
  latencyMs        Int?
  statusCode       Int?
  rawRef           Json? // Provider request ID and metadata
  organization     Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  team             Team?        @relation(fields: [teamId], references: [id], onDelete: SetNull)
  project          Project?     @relation(fields: [projectId], references: [id], onDelete: SetNull)
  app              App?         @relation(fields: [appId], references: [id], onDelete: SetNull)
  client           Client?      @relation(fields: [clientId], references: [id], onDelete: SetNull)

  @@index([orgId])
  @@index([orgId, occurredAt])
  @@index([orgId, provider, model])
  @@index([orgId, userId])
  @@index([orgId, teamId])
  @@index([orgId, projectId])
  @@index([orgId, appId])
  @@index([orgId, clientId])
}

// Directory models for dimension attribution
model Team {
  id            String         @id @default(cuid())
  orgId         String
  name          String
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  organization  Organization   @relation(fields: [orgId], references: [id], onDelete: Cascade)
  memberships   Membership[]
  costEvents    CostEvent[]
  aiRequestLogs AiRequestLog[]

  @@index([orgId])
  @@index([orgId, name])
}

model Project {
  id            String         @id @default(cuid())
  orgId         String
  name          String
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  organization  Organization   @relation(fields: [orgId], references: [id], onDelete: Cascade)
  costEvents    CostEvent[]
  aiRequestLogs AiRequestLog[]
  aiGatewayKeys AiGatewayKey[] // Keys with this as defaultProject

  @@index([orgId])
  @@index([orgId, name])
}

model App {
  id            String         @id @default(cuid())
  orgId         String
  name          String
  slug          String // Unique per org for API/URL usage
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  organization  Organization   @relation(fields: [orgId], references: [id], onDelete: Cascade)
  costEvents    CostEvent[]
  aiRequestLogs AiRequestLog[]
  aiGatewayKeys AiGatewayKey[] // Keys with this as defaultApp

  @@unique([orgId, slug])
  @@index([orgId])
  @@index([orgId, name])
  @@index([orgId, slug])
}

model Client {
  id            String         @id @default(cuid())
  orgId         String
  name          String
  externalId    String? // External identifier (e.g., customer ID from another system)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  organization  Organization   @relation(fields: [orgId], references: [id], onDelete: Cascade)
  costEvents    CostEvent[]
  aiRequestLogs AiRequestLog[]
  aiGatewayKeys AiGatewayKey[] // Keys with this as defaultClient

  @@index([orgId])
  @@index([orgId, name])
  @@index([orgId, externalId])
}

// User notification preferences (per org)
model NotificationPreference {
  id              String       @id @default(cuid())
  orgId           String
  userId          String       @unique
  emailEnabled    Boolean      @default(true)
  telegramEnabled Boolean      @default(false)
  telegramChatId  String?
  slackEnabled    Boolean      @default(false)
  teamsEnabled    Boolean      @default(false)
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  user            User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization    Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@unique([orgId, userId])
  @@index([orgId])
  @@index([userId])
}

// Organization integrations (Telegram bot token, Slack, Teams, etc.)
model OrgIntegration {
  id                    String       @id @default(cuid())
  orgId                 String       @unique
  telegramBotTokenEnc   String? // Encrypted bot token
  telegramBotTokenLast4 String? // Last 4 chars for display
  slackWebhookUrlEnc    String? // Encrypted Slack webhook URL
  slackWebhookUrlLast4  String? // Last 4 chars for display
  teamsWebhookUrlEnc    String? // Encrypted Teams webhook URL
  teamsWebhookUrlLast4  String? // Last 4 chars for display
  createdAt             DateTime     @default(now())
  updatedAt             DateTime     @updatedAt
  organization          Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@index([orgId])
}

// Notification delivery tracking with retry support
model NotificationDelivery {
  id            String    @id @default(cuid())
  orgId         String
  notificationId String?  // Optional reference to notification/alert ID
  channel       String    // "EMAIL" | "TELEGRAM" | "INAPP" | "SLACK" | "TEAMS" | "WEBHOOK"
  status        String    @default("PENDING") // "PENDING" | "SENT" | "FAILED" | "RETRYING"
  attempt       Int       @default(1)
  lastError     String?
  nextRetryAt   DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  organization  Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@index([orgId, status])
  @@index([nextRetryAt])
  @@index([channel])
  @@index([orgId])
  @@index([status, nextRetryAt])
}

// AI Provider Connections (OpenAI, Anthropic, xAI, Google, Mistral)
enum AiProvider {
  OPENAI
  ANTHROPIC
  XAI
  GOOGLE
  MISTRAL
}

enum AiProviderConnectionStatus {
  ACTIVE
  DISABLED
}

model AiProviderConnection {
  id              String                     @id @default(cuid())
  orgId           String
  provider        AiProvider
  name            String
  status          AiProviderConnectionStatus @default(ACTIVE)
  encryptedApiKey String // TEXT - encrypted API key
  keyLast4        String // Last 4 chars for display
  createdAt       DateTime                   @default(now())
  updatedAt       DateTime                   @updatedAt
  organization    Organization               @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@unique([orgId, provider, name])
  @@index([orgId])
  @@index([orgId, provider])
  @@index([orgId, status])
}

// AI Model Routes (which provider/model to use)
model AiModelRoute {
  id               String       @id @default(cuid())
  orgId            String
  provider         AiProvider
  model            String // Model identifier (e.g., "gpt-4", "claude-3-opus")
  enabled          Boolean      @default(true)
  priority         Int          @default(100) // Lower = higher priority
  maxCostPerReqEUR Float? // Optional max cost per request
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt
  organization     Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@unique([orgId, provider, model])
  @@index([orgId])
  @@index([orgId, provider])
  @@index([orgId, enabled])
}

// Cron run logs for monitoring (proof of execution)
model CronRunLog {
  id              String   @id @default(cuid())
  cronName        String // e.g., "run-alerts", "sync-aws-cur"
  ranAt           DateTime @default(now()) // Execution timestamp
  status          String   @default("OK") // "OK" | "ERROR"
  orgsProcessed   Int      @default(0)
  alertsTriggered Int      @default(0)
  sentEmail       Int      @default(0)
  sentTelegram    Int      @default(0)
  sentInApp       Int      @default(0)
  durationMs      Int? // Execution duration in milliseconds
  errorCount      Int      @default(0)
  errorSample     String? // First error message (truncated to 500 chars)

  @@index([cronName])
  @@index([ranAt])
  @@index([cronName, ranAt])
  @@index([status])
}

// CronRun model for production hardening (PR13)
model CronRun {
  id         String    @id @default(cuid())
  orgId      String? // Nullable for org-agnostic crons
  type       String // "RUN_ALERTS" | "APPLY_RETENTION" | "SYNC_AWS_CUR"
  status     String // "SUCCESS" | "FAIL"
  startedAt  DateTime  @default(now())
  finishedAt DateTime?
  error      String? // Error message if status=FAIL
  metaJson   String? // JSON metadata (stored as text)

  organization Organization? @relation(fields: [orgId], references: [id], onDelete: SetNull)

  @@index([type])
  @@index([status])
  @@index([startedAt])
  @@index([type, startedAt])
  @@index([orgId])
}

// API Key usage windows for rate limiting (60s windows)
model ApiKeyUsageWindow {
  id           String       @id @default(cuid())
  keyId        String
  windowStart  DateTime // Start of 60s window (truncated to minute)
  count        Int          @default(0) // Request count in this window
  aiGatewayKey AiGatewayKey @relation(fields: [keyId], references: [id], onDelete: Cascade)

  @@unique([keyId, windowStart])
  @@index([keyId])
  @@index([windowStart])
}

// Organization webhooks for events (cost_event, alert_event, ai_request)
model OrgWebhook {
  id           String       @id @default(cuid())
  orgId        String
  url          String // Webhook URL
  secretEnc    String // Encrypted HMAC secret (AES-GCM)
  secretHash   String? // SHA-256 hash of secret (optional, for lookup)
  enabled      Boolean      @default(true)
  events       String[] // Array of event types: "cost_event.created", "alert_event.triggered", "ai_request.completed"
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  deliveries   OrgWebhookDelivery[]

  @@index([orgId])
  @@index([orgId, enabled])
}

model OrgWebhookDelivery {
  id          String       @id @default(cuid())
  orgId       String
  webhookId   String
  eventType   String // "cost_event.created" | "alert_event.triggered" | "ai_request.completed"
  status      String // "SUCCESS" | "FAIL"
  attempt     Int          @default(1) // 1, 2, or 3
  httpStatus  Int? // HTTP status code from webhook endpoint
  error       String? // Error message if failed
  requestId   String? // Unique request ID for this delivery
  deliveredAt DateTime     @default(now())
  createdAt   DateTime     @default(now())
  payloadJson String? // JSON payload (optional, for debugging)
  durationMs  Int? // Delivery duration in milliseconds
  webhook     OrgWebhook   @relation(fields: [webhookId], references: [id], onDelete: Cascade)
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@index([webhookId])
  @@index([eventType])
  @@index([status])
  @@index([createdAt])
  @@index([orgId])
  @@index([requestId])
}
